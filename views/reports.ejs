<% const title = 'Reports & Analytics'; %>
<div class="card">
	<h2>Reports & Analytics</h2>
	<div style="display:flex;gap:16px;flex-wrap:wrap">
		<div style="flex:1;min-width:280px">
			<h3>Daily Meal Counts (last 14 days)</h3>
			<canvas id="chartDaily" height="120"></canvas>
		</div>
		<div style="flex:1;min-width:280px">
			<h3>Weekly Meal Counts (last 8 weeks)</h3>
			<canvas id="chartWeekly" height="120"></canvas>
		</div>
	</div>
	<div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:16px">
		<div style="flex:1;min-width:280px">
			<h3>Most Requested Dishes</h3>
			<canvas id="chartTop" height="140"></canvas>
		</div>
		<div style="flex:1;min-width:280px">
			<h3>Orders by Dietary Restriction</h3>
			<canvas id="chartDiet" height="140"></canvas>
		</div>
	</div>
	<div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:16px">
		<div style="flex:1;min-width:280px">
			<h3>Waste by Ward (Daily % wasted)</h3>
			<canvas id="chartWaste" height="140"></canvas>
		</div>
	</div>

	<div style="margin-top:16px">
		<a href="/admin/reports/export.csv"><button>Export CSV</button></a>
		<a href="/admin/reports/export.pdf" style="margin-left:8px"><button>Export PDF</button></a>
		<a href="/admin/reports/export.xlsx" style="margin-left:8px"><button>Export Excel</button></a>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
	var daily = <%- JSON.stringify(daily) %>;
	var weekly = <%- JSON.stringify(weekly) %>;
	var topDishes = <%- JSON.stringify(topDishes) %>;
	var byDiet = <%- JSON.stringify(byDiet) %>;
	var wasteByWardDaily = <%- JSON.stringify(wasteByWardDaily) %>;

	function lineChart(ctx, labels, data, label){
		return new Chart(ctx, { type:'line', data:{ labels: labels, datasets:[{ label: label, data: data, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.2)', tension:0.2, fill:true }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } });
	}
	function barChart(ctx, labels, data, label){
		return new Chart(ctx, { type:'bar', data:{ labels: labels, datasets:[{ label: label, data: data, backgroundColor:'#10b981' }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } });
	}

	lineChart(document.getElementById('chartDaily'), daily.map(d=>d.day), daily.map(d=>d.count), 'Daily Meals');
	lineChart(document.getElementById('chartWeekly'), weekly.map(d=>d.week), weekly.map(d=>d.count), 'Weekly Meals');
	barChart(document.getElementById('chartTop'), topDishes.map(d=>d.item_name), topDishes.map(d=>d.count), 'Top Dishes');
	barChart(document.getElementById('chartDiet'), byDiet.map(d=>d.restriction), byDiet.map(d=>d.count), 'Dietary');

	// Waste by Ward stacked bar: each ward is a dataset, x-axis is day, value is avg waste %
	(function(){
		var days = Array.from(new Set(wasteByWardDaily.map(d => d.day)));
		var wards = Array.from(new Set(wasteByWardDaily.map(d => d.ward)));
		var datasets = wards.map(function(ward, i){
			var colorPool = ['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899'];
			var color = colorPool[i % colorPool.length];
			return {
				label: ward,
				backgroundColor: color,
				data: days.map(function(day){
					var rec = wasteByWardDaily.find(function(r){ return r.day === day && r.ward === ward; });
					return rec ? Number(rec.waste_percent) : 0;
				})
			};
		});
		new Chart(document.getElementById('chartWaste'), {
			type: 'bar',
			data: { labels: days, datasets: datasets },
			options: {
				plugins: { legend: { position: 'bottom' } },
				responsive: true,
				scales: {
					x: { stacked: true },
					y: { stacked: true, beginAtZero: true, ticks: { callback: function(v){ return v + '%'; } } }
				}
			}
		});
	})();
})();
</script>


